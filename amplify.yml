version: 1

env:
  variables:
    NODE_VERSION: '20'   # ensure Node 20 ABI

backend:
  phases:
    preBuild:            # NEW: split install to preBuild
      commands:
        - node -v && npm -v
        - npm i -g npm@11.3.0
        - npm -v
        - npm ci
    build:
      commands:
        # Compile backend TS (keep your current behavior)
        - npx tsc -p amplify/tsconfig.json --pretty false || true
        - echo "Running ampx pipeline-deploy with debug logging"
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID --debug

frontend:
  phases:
    preBuild:            # NEW: ensure deps before build phase
      commands:
        # Reuse node_modules installed in backend; if Amplify
        # runs frontend in a fresh phase, this makes it explicit.
        - test -d node_modules || npm ci --cache .npm --prefer-offline
        # Safety: if watcher still missing, build it from source
        - npm rebuild @parcel/watcher --build-from-source || true
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*